# retrieves census data on the percent of the population that is elderly or disabled and medium income for each county

from census import Census
from us import states
import pandas as pd
from dotenv import load_dotenv
import os

load_dotenv()
CENSUS_API_KEY = os.getenv("CENSUS_API_KEY")

if not CENSUS_API_KEY:
    raise ValueError("CENSUS_API_KEY environment variable not set")

c = Census(CENSUS_API_KEY)

def get_data(state): # call function with state abb (ex. CA, NY)
    state_fips = states.lookup(state).fips
    data = c.acs5.state_place(
        fields=[
            "B01001_001E", #total population

            # males 65 & up
            "B01001_020E",
            "B01001_021E",
            "B01001_022E",
            "B01001_023E",
            "B01001_024E",
            "B01001_025E",
           
            # females 65 & up
            "B01001_044E",
            "B01001_045E",
            "B01001_046E",
            "B01001_047E",
            "B01001_048E",
            "B01001_049E",

            "B19013_001E", # median household income (past 12 mo)

            # males with a disability
            "B18101_004E",
            "B18101_007E",
            "B18101_010E",
            "B18101_013E",
            "B18101_016E",
            "B18101_019E",

            #females with a disability
            "B18101_023E",
            "B18101_026E",
            "B18101_029E",
            "B18101_032E",
            "B18101_035E",
            "B18101_038E",
        ],
        state_fips=state_fips,
        place="*"
    )

    df = pd.DataFrame(data)

    over_65_codes = [
        "B01001_020E", "B01001_021E", "B01001_022E", "B01001_023E", "B01001_024E", "B01001_025E",
        "B01001_044E", "B01001_045E", "B01001_046E", "B01001_047E", "B01001_048E", "B01001_049E"
    ]

    disability_codes = [
        "B18101_004E", "B18101_007E", "B18101_010E", "B18101_013E", "B18101_016E", "B18101_019E",
        "B18101_023E", "B18101_026E", "B18101_029E", "B18101_032E", "B18101_035E", "B18101_038E",
    ]
    
    # save everything as an integer
    df[over_65_codes + disability_codes + ["B01001_001E", "B19013_001E"]] = df[over_65_codes + disability_codes + ["B01001_001E", "B19013_001E"]].astype(int)

    df = df[df["B01001_001E"] >= 50] # remove cities/places with populations under 50

    df["percent_over_65"] = df[over_65_codes].sum(axis=1) / df["B01001_001E"]
    df["median_income"] = df["B19013_001E"]
    df["percent_disabled"] = df[disability_codes].sum(axis=1) / df["B01001_001E"]

    df = df[["state", "place", "percent_over_65", "median_income", "percent_disabled"]]

    return df

