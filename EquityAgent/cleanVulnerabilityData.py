import numpy as np
from us import states
import pandas as pd
import os

def clean_data(filepath: str):
    input_file = filepath
    df = pd.read_csv(input_file)

    # use census gazetteer to replace place and state codes with actual names
    gazetteer = pd.read_csv("2024_Gaz_place_national.txt", delimiter="\t", dtype={"GEOID": str})

    df["state"] = df["state"].astype(str).str.zfill(2)
    df["place"] = df["place"].astype(str).str.zfill(5)
    df["GEOID"] = df["state"] + df["place"]

    df = df.merge(
        gazetteer[["GEOID", "NAME", "USPS"]],
        on="GEOID",
        how="left"
    )

    df = df.drop(columns=["state", "place"])
    df = df.rename(columns={"NAME": "place", "USPS": "state"})
    df = df[["state", "place", "percent_over_65", "median_income", "percent_disabled"]]

    # fix median income invalid values
    df["median_income"] = pd.to_numeric(df["median_income"], errors='coerce')
    df.loc[df["median_income"] < 0, "median_income"] = "Not Reported"

    filename, ext = os.path.splitext(input_file)
    output_file = f"{filename}_clean.csv"
    df.to_csv(output_file, index=False)

    print(f"Cleaned file saved as: {output_file}")
